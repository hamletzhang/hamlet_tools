<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER LANDLORD: FIXED INTERACTION</title>
    <style>
        /* --- 1. åŸºç¡€æ ·å¼ (ä¿æŒèµ›åšé£) --- */
        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-gold: #ffd700;
            --bg-dark: #050510;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at 50% 120%, #1a0b2e 0%, #000000 80%);
            font-family: 'Segoe UI', sans-serif;
            color: white;
            user-select: none;
            height: 100vh;
        }

        /* ç½‘æ ¼èƒŒæ™¯ */
        .cyber-grid {
            position: absolute; width: 200%; height: 200%; top: -50%; left: -50%;
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(188, 19, 254, 0.1) 1px, transparent 1px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg);
            animation: gridFlow 20s linear infinite;
            z-index: -1;
        }
        @keyframes gridFlow { 0% {transform:perspective(500px) rotateX(60deg) translateY(0);} 100% {transform:perspective(500px) rotateX(60deg) translateY(60px);} }

        /* --- 2. å¸ƒå±€ --- */
        .stage {
            display: grid; width: 100vw; height: 100vh;
            grid-template-areas: "top" "main" "bottom";
            grid-template-rows: 100px 1fr 220px;
        }

        /* é¡¶éƒ¨ */
        .top-bar { grid-area: top; display: flex; justify-content: center; align-items: center; position: relative; }
        .hole-cards { display: flex; gap: 10px; }
        .hole-card { 
            width: 45px; height: 60px; background: #222; border: 1px solid #555; border-radius: 4px;
            display: flex; justify-content: center; align-items: center; font-weight: bold; transition: 0.5s;
        }
        .hole-card.revealed { background: white; color: black; transform: rotateY(360deg); border-color: var(--neon-gold); }
        .scoreboard { 
            position: absolute; right: 20px; top: 20px; 
            background: rgba(0,0,0,0.5); border: 1px solid var(--neon-blue); padding: 5px 15px; border-radius: 4px;
        }

        /* ä¸»åŒºåŸŸ (AI + æ¡Œå­) */
        .main-area { grid-area: main; display: grid; grid-template-columns: 150px 1fr 150px; position: relative; }
        .ai-zone { display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        .avatar {
            width: 70px; height: 70px; border-radius: 50%; border: 2px solid #555;
            background: #111; display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 2; transition: 0.3s;
        }
        .avatar.active { border-color: var(--neon-blue); box-shadow: 0 0 20px var(--neon-blue); transform: scale(1.1); }
        .role-badge { font-size: 10px; background: #333; padding: 2px 6px; border-radius: 4px; margin-top: -10px; z-index: 3;}
        .bubble { 
            position: absolute; top: -30px; background: white; color: black; 
            padding: 5px 10px; border-radius: 8px; font-weight: bold; opacity: 0; transition: 0.2s; 
            white-space: nowrap; pointer-events: none;
        }
        .bubble.show { opacity: 1; top: -40px; }

        .table-center { position: relative; display: flex; justify-content: center; align-items: center; }
        .played-card-group { display: flex; position: absolute; } /* å‡ºç‰Œå±•ç¤ºå®¹å™¨ */

        /* åº•éƒ¨ (ç©å®¶) */
        .bottom-area { grid-area: bottom; position: relative; display: flex; justify-content: center; padding-top: 40px;}
        
        /* æ ¸å¿ƒä¿®å¤ï¼šæ“ä½œæŒ‰é’®å±‚ */
        .control-layer {
            position: absolute;
            top: -60px; /* ä½äºæ‰‹ç‰Œä¸Šæ–¹ */
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 15px;
            z-index: 999; /* å¿…é¡»æœ€é«˜ */
            pointer-events: auto;
        }

        .btn {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            transition: 0.2s;
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }
        .btn:hover { background: var(--neon-blue); color: black; box-shadow: 0 0 20px var(--neon-blue); transform: translateY(-2px); }
        .btn.primary { border-color: var(--neon-pink); color: var(--neon-pink); }
        .btn.primary:hover { background: var(--neon-pink); color: white; box-shadow: 0 0 20px var(--neon-pink); }
        .btn:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

        /* å¡ç‰Œæ ·å¼ */
        .card {
            width: 90px; height: 125px; background: #eee; border-radius: 6px;
            position: absolute; border: 1px solid #ccc;
            display: flex; flex-direction: column; justify-content: space-between; padding: 5px; box-sizing: border-box;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.5); cursor: pointer; transition: 0.2s;
        }
        .card:hover { transform: translateY(-20px); z-index: 100; border-color: var(--neon-blue); }
        .card.selected { transform: translateY(-30px); border: 2px solid var(--neon-pink); box-shadow: 0 0 15px var(--neon-pink); }
        .suit-red { color: #d00; } .suit-black { color: #222; }
        .card-val { font-size: 20px; font-weight: 900; line-height: 1; }
        .card-suit { font-size: 16px; }
        .card-center { font-size: 40px; align-self: center; opacity: 0.3; }

        /* å¼€å§‹é®ç½© */
        #start-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .title-txt { font-size: 60px; color: white; text-shadow: 0 0 20px var(--neon-blue); margin-bottom: 30px; font-weight: 900; letter-spacing: 5px; }

        /* ç‰¹æ•ˆå­— */
        .fx-text { position: absolute; font-size: 40px; font-weight: bold; color: white; text-shadow: 0 0 10px gold; animation: pop 0.5s ease-out; z-index: 1000; pointer-events: none;}
        @keyframes pop { 0% {transform:scale(0); opacity:0;} 50% {transform:scale(1.2);} 100% {transform:scale(1); opacity:0;} }

    </style>
</head>
<body>

<div class="cyber-grid"></div>

<div id="start-screen">
    <div class="title-txt">æ–—åœ°ä¸» PROTOCOL</div>
    <button class="btn primary" style="font-size: 24px; padding: 15px 50px;" onclick="game.start()">å¼€å§‹æ¸¸æˆ / DEAL</button>
</div>

<div class="stage">
    <div class="top-bar">
        <div class="hole-cards" id="hole-area">
            <div class="hole-card"></div><div class="hole-card"></div><div class="hole-card"></div>
        </div>
        <div class="scoreboard">
            <div>å€æ•°: <span id="mul-display" style="color:var(--neon-gold)">x1</span></div>
            <div id="state-display" style="font-size:12px; color:#aaa;">WAITING</div>
        </div>
    </div>

    <div class="main-area">
        <div class="ai-zone">
            <div class="avatar" id="av-2"><span style="font-size:20px">ğŸ¤–</span></div>
            <div class="role-badge" id="role-2">å†œæ°‘</div>
            <div style="font-size:12px; color:#888; margin-top:5px;">å‰©ä½™: <span id="cnt-2">17</span></div>
            <div class="bubble" id="bubble-2"></div>
            <div class="played-card-group" id="play-2" style="left: 120%; top: 40%;"></div>
        </div>

        <div class="table-center">
            <div class="played-card-group" id="play-0" style="bottom: 20px;"></div>
        </div>

        <div class="ai-zone">
            <div class="avatar" id="av-1"><span style="font-size:20px">ğŸ‘¾</span></div>
            <div class="role-badge" id="role-1">å†œæ°‘</div>
            <div style="font-size:12px; color:#888; margin-top:5px;">å‰©ä½™: <span id="cnt-1">17</span></div>
            <div class="bubble" id="bubble-1"></div>
            <div class="played-card-group" id="play-1" style="right: 120%; top: 40%;"></div>
        </div>
    </div>

    <div class="bottom-area">
        <div class="control-layer" id="controls"></div>

        <div id="my-hand" style="position: relative; width: 800px; height: 140px;"></div>
        
        <div class="avatar" id="av-0" style="position:absolute; left:20px; bottom:20px;">
            <span>YOU</span>
        </div>
        <div class="role-badge" id="role-0" style="position:absolute; left:40px; bottom:10px;">å†œæ°‘</div>
        <div class="bubble" id="bubble-0" style="left:20px; bottom: 80px; top:auto;"></div>
    </div>
</div>

<script>
/**
 * ä¿®å¤ç‰ˆé€»è¾‘æ ¸å¿ƒ
 * é‡ç‚¹ï¼šäººç±»å›åˆå¼ºåˆ¶ä¸­æ–­å¾ªç¯ï¼Œç­‰å¾… UI å›è°ƒ
 */

const SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
const DISPLAY = ['3','4','5','6','7','8','9','10','J','Q','K','A','2','å°ç‹','å¤§ç‹'];
// é€»è¾‘å€¼
const VALS = {
    '3':3, '4':4, '5':5, '6':6, '7':7, '8':8, '9':9, '10':10, 
    'J':11, 'Q':12, 'K':13, 'A':14, '2':15, 'å°ç‹':16, 'å¤§ç‹':17
};

class Card {
    constructor(val, suit) {
        this.val = val;
        this.suit = suit;
        this.label = DISPLAY[val - 3];
        this.id = Math.random().toString(36).substr(2,9);
        this.selected = false;
    }
    get isRed() { return this.suit === 'â™¥' || this.suit === 'â™¦' || this.val >= 16; }
}

// ç®€å•çš„ç‰Œå‹è§„åˆ™å¼•æ“ (ä¿ç•™åŸºç¡€åŠŸèƒ½ä»¥ç¡®ä¿æ¸¸æˆèƒ½è·‘)
const Rule = {
    analyze(cards) {
        if(!cards.length) return null;
        cards.sort((a,b) => a.val - b.val);
        const len = cards.length;
        const vals = cards.map(c=>c.val);
        const counts = {};
        vals.forEach(v=>counts[v]=(counts[v]||0)+1);
        const maxRep = Math.max(...Object.values(counts));

        // ç®€å•åˆ¤å®š
        if(len===1) return {type:'single', val:vals[0]};
        if(len===2 && vals[0]===vals[1]) return {type:'pair', val:vals[0]};
        if(len===2 && vals[0]===16 && vals[1]===17) return {type:'rocket', val:999};
        if(len===3 && maxRep===3) return {type:'triple', val:vals[0]};
        if(len===4 && maxRep===4) return {type:'bomb', val:vals[0]};
        if(len===4 && maxRep===3) return {type:'3+1', val: Object.keys(counts).find(k=>counts[k]===3)};
        if(len===5 && maxRep===3 && Object.keys(counts).length===2) return {type:'3+2', val: Object.keys(counts).find(k=>counts[k]===3)};
        // é¡ºå­ç®€åŒ–åˆ¤å®š (5å¼ ä»¥ä¸Šï¼Œæ— 2å’Œç‹ï¼Œè¿ç»­)
        if(len>=5 && maxRep===1 && vals[len-1]<15 && vals[len-1]-vals[0]===len-1) return {type:'straight', val:vals[len-1], len:len};
        
        return null; // å…¶ä»–å¿½ç•¥
    },
    canBeat(prev, currCards) {
        if(!prev) return true; // å…ˆæ‰‹
        const curr = this.analyze(currCards);
        if(!curr) return false; // éæ³•ç‰Œå‹

        if(curr.type === 'rocket') return true;
        if(prev.type === 'rocket') return false;
        if(curr.type === 'bomb' && prev.type !== 'bomb') return true;
        
        if(curr.type === prev.type) {
            if(curr.type === 'straight' && curr.len !== prev.len) return false;
            return curr.val > prev.val;
        }
        return false;
    }
};

class Game {
    constructor() {
        this.resetData();
    }

    resetData() {
        this.players = [
            { id:0, isHuman:true, cards:[], role:'farmer' },
            { id:1, isHuman:false, cards:[], role:'farmer' },
            { id:2, isHuman:false, cards:[], role:'farmer' }
        ];
        this.state = 'IDLE'; // IDLE, BIDDING, SNATCHING, PLAYING, OVER
        this.deck = [];
        this.holeCards = [];
        this.turn = -1;
        this.callScore = 0; // 0, 1, 2, 3
        this.landlord = -1;
        this.multiplier = 15; // åŸºç¡€å€æ•°æ¼”ç¤º
        this.lastPlay = null; // {pid, typeObj, cards}
        this.passCount = 0;
    }

    start() {
        document.getElementById('start-screen').style.display = 'none';
        this.resetData();
        this.initDeck();
        this.deal();
        
        // æ¸²æŸ“æ‰‹ç‰Œ
        ui.renderHand(this.players[0].cards);
        ui.updateInfo();
        
        // éšæœºå¼€å§‹å«åˆ†
        this.state = 'BIDDING';
        this.turn = Math.floor(Math.random()*3);
        ui.showToast(`æ¸¸æˆå¼€å§‹ï¼ŒP${this.turn} å…ˆå«`);
        
        this.loop();
    }

    initDeck() {
        let arr = [];
        for(let v=3; v<=15; v++) for(let s=0; s<4; s++) arr.push(new Card(v, SUITS[s]));
        arr.push(new Card(16,''), new Card(17,''));
        arr.sort(()=>Math.random()-0.5);
        this.deck = arr;
    }

    deal() {
        this.players[0].cards = this.deck.slice(0,17).sort((a,b)=>b.val-a.val);
        this.players[1].cards = this.deck.slice(17,34);
        this.players[2].cards = this.deck.slice(34,51);
        this.holeCards = this.deck.slice(51);
        ui.updateCounts();
    }

    // --- æ ¸å¿ƒå¾ªç¯ ---
    loop() {
        if(this.state === 'OVER') return;

        ui.highlightAvatar(this.turn);
        const p = this.players[this.turn];

        // *** å…³é”®ä¿®å¤ï¼šå¦‚æœæ˜¯äººç±»ï¼Œåœæ­¢å¾ªç¯ï¼Œæ¸²æŸ“æŒ‰é’®ï¼Œç­‰å¾…å›è°ƒ ***
        if(p.isHuman) {
            if(this.state === 'BIDDING') ui.showBidBtns(this.callScore);
            else if(this.state === 'SNATCHING') ui.showSnatchBtns();
            else if(this.state === 'PLAYING') ui.showPlayBtns(this.lastPlay);
            return; // æš‚åœï¼
        }

        // å¦‚æœæ˜¯AIï¼Œå»¶è¿Ÿæ‰§è¡Œ
        setTimeout(() => {
            this.aiMove();
        }, 800);
    }

    // --- AI é€»è¾‘ ---
    aiMove() {
        const p = this.players[this.turn];
        
        if(this.state === 'BIDDING') {
            // ç®€å•å«åˆ†é€»è¾‘
            let score = Math.floor(Math.random()*4); // 0-3
            if(score <= this.callScore) score = 0;
            this.handleBid(score);
        }
        else if(this.state === 'SNATCHING') {
            // ç®€å•æŠ¢åœ°ä¸»ï¼š50%æ¦‚ç‡
            const want = Math.random() > 0.5;
            this.handleSnatch(want);
        }
        else if(this.state === 'PLAYING') {
            // å‡ºç‰Œé€»è¾‘
            let toPlay = [];
            // å¦‚æœæˆ‘æ˜¯å…ˆæ‰‹(lastPlayä¸ºç©ºï¼Œæˆ–æ˜¯æˆ‘è‡ªå·±å‡ºçš„)ï¼Œéšä¾¿å‡ºä¸€å¼ æœ€å°çš„
            if(!this.lastPlay || this.lastPlay.pid === this.turn) {
                // æ‰¾æœ€å°å•å¼ 
                p.cards.sort((a,b)=>a.val-b.val);
                toPlay = [p.cards[0]];
            } else {
                // ç®¡ç‰Œé€»è¾‘ï¼šæ‰¾ä¸ªèƒ½ç®¡ä¸Šçš„
                const prev = this.lastPlay.typeObj;
                // æç®€AIï¼šåªç®¡å•å¼ å’Œå¯¹å­
                if(prev.type === 'single') {
                    const c = p.cards.find(c => c.val > prev.val);
                    if(c) toPlay = [c];
                }
                else if(prev.type === 'pair') {
                    // æ‰¾å¯¹å­
                    // çœç•¥å¤æ‚æŸ¥æ‰¾ï¼Œä¸ºäº†ä¸æŠ¥é”™ï¼ŒAIå¦‚æœæ˜¯å¤æ‚ç‰Œå‹ç›´æ¥ä¸è¦
                }
            }

            this.handlePlay(toPlay);
        }
    }

    // --- åŠ¨ä½œå¤„ç† (äººç±»å’ŒAIå…±ç”¨) ---

    // 1. å«åˆ†å¤„ç†
    handleBid(score) {
        ui.bubble(this.turn, score>0 ? `${score}åˆ†` : "ä¸å«");
        
        if(score > this.callScore) {
            this.callScore = score;
            this.landlord = this.turn; // æš‚å®š
            this.multiplier = score * 5; // æ¼”ç¤ºå€ç‡
        }

        // ç®€åŒ–æµç¨‹ï¼šåªè¦æœ‰äººå«äº†3åˆ†ï¼Œæˆ–è€…è½®äº†ä¸€åœˆï¼Œç»“æŸ
        // è¿™é‡Œä¸ºäº†æ¼”ç¤ºâ€œæŠ¢åœ°ä¸»â€ï¼Œæˆ‘ä»¬å¼ºåˆ¶è®¾å®šï¼šåªè¦å«åˆ†ç»“æŸï¼ˆä¸ç®¡å‡ åˆ†ï¼‰ï¼Œè¿›å…¥æŠ¢åœ°ä¸»
        // å®é™…é€»è¾‘åº”è¯¥æ›´å¤æ‚ã€‚è¿™é‡Œç®€åŒ–ä¸ºï¼šæœ‰äººå«åˆ†åï¼Œç«‹åˆ»è¿›å…¥æŠ¢åœ°ä¸»é˜¶æ®µ
        
        // è½®è½¬
        // ç®€åŒ– Demoï¼šæ¯äººå«ä¸€æ¬¡ï¼Œè°æœ€é«˜è°å½“åœ°ä¸»ï¼Œç„¶åè¿›å…¥æŠ¢åœ°ä¸»ç¯èŠ‚ï¼ˆx2ï¼‰
        const next = (this.turn + 1) % 3;
        
        // å¦‚æœå›åˆ°ç¬¬ä¸€ä¸ªå«åˆ†çš„äººï¼Œæˆ–è€…å·²ç»å«äº†3åˆ† -> è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
        // è¿™é‡Œå¼ºè¡Œç®€åŒ–ï¼šå¦‚æœå½“å‰å«äº† >0 åˆ†ï¼Œä¸”ä¸‹å®¶æ˜¯å¼€å§‹è€…ï¼Œç»“æŸå«åˆ†
        // ä¸ºäº†è®©ç”¨æˆ·èƒ½ä½“éªŒï¼Œè¿™é‡Œè®¾å®šï¼šå¦‚æœæœ‰äººå«åˆ†ï¼Œç«‹åˆ»å±•ç¤ºåº•ç‰Œï¼Œè¿›å…¥æŠ¢åœ°ä¸»
        if(score > 0) {
            this.state = 'SNATCHING';
            this.turn = (this.turn + 1) % 3; // ä¸‹å®¶å¼€å§‹æŠ¢
            ui.showToast(`æœ‰äººå«åˆ†ï¼è¿›å…¥æŠ¢åœ°ä¸»é˜¶æ®µ`);
            ui.revealHole();
            this.loop();
        } else {
            // æ²¡äººå«ï¼Œä¸‹ä¸€ä¸ª
            this.turn = next;
            // å¦‚æœè½¬äº†ä¸€åœˆéƒ½æ²¡äººå«... é‡å‘ (çœç•¥ï¼Œç›´æ¥ç»§ç»­è½¬)
            this.loop();
        }
    }

    // 2. æŠ¢åœ°ä¸»å¤„ç†
    handleSnatch(isSnatch) {
        ui.bubble(this.turn, isSnatch ? "æŠ¢åœ°ä¸»!" : "ä¸æŠ¢");
        if(isSnatch) {
            this.multiplier *= 2;
            this.landlord = this.turn; // æŠ¢åˆ°äº†
            ui.effectText('x2');
        }
        
        // ç®€åŒ–ï¼šæŠ¢ä¸€è½®å°±ç»“æŸ
        // å®é™…ä¸Šåº”è¯¥ç»´æŠ¤ä¸€ä¸ªæŠ¢åœ°ä¸»åˆ—è¡¨ã€‚
        // Demoé€»è¾‘ï¼šåªè¦å‘ç”Ÿè¿‡æŠ¢/ä¸æŠ¢ï¼Œå¹¶ä¸”è½®å›äº†åŸå«åˆ†è€…ï¼Œæˆ–è€…æŠ¢äº†ä¹‹åç›´æ¥å®š
        // ä¸ºäº†ä½“éªŒï¼šæŠ¢å®Œä¸€æ¬¡ç›´æ¥å®šåœ°ä¸»å¼€å§‹æ‰“ç‰Œ
        
        this.state = 'PLAYING';
        this.turn = this.landlord; // åœ°ä¸»å…ˆå‡º
        
        // è®¾ç½®èº«ä»½
        this.players.forEach(p => p.role = (p.id===this.landlord) ? 'landlord' : 'farmer');
        ui.updateRoles();
        
        // ç»™åœ°ä¸»å‘åº•ç‰Œ
        this.players[this.landlord].cards.push(...this.holeCards);
        this.players[this.landlord].cards.sort((a,b)=>b.val-a.val);
        ui.updateCounts();
        if(this.landlord === 0) ui.renderHand(this.players[0].cards);
        
        ui.showToast('å¼€å§‹å‡ºç‰Œï¼åœ°ä¸»å…ˆå‡º');
        ui.updateInfo();
        this.loop();
    }

    // 3. å‡ºç‰Œå¤„ç†
    handlePlay(cards) {
        const p = this.players[this.turn];

        if(cards.length === 0) {
            ui.bubble(this.turn, "ä¸è¦");
            this.passCount++;
        } else {
            // å‡ºç‰ŒæˆåŠŸ
            const analysis = Rule.analyze(cards);
            ui.displayPlay(this.turn, cards); // å±•ç¤º
            
            // ç§»é™¤æ‰‹ç‰Œ
            const ids = cards.map(c=>c.id);
            p.cards = p.cards.filter(c => !ids.includes(c.id));
            if(p.id === 0) ui.renderHand(p.cards);
            ui.updateCounts();

            this.lastPlay = { pid: this.turn, typeObj: analysis, cards: cards };
            this.passCount = 0; // é‡ç½®è¿‡ç‰Œ
            
            // ç‰¹æ•ˆ
            if(analysis.type === 'bomb') { this.multiplier *= 2; ui.effectText('BOMB'); }
            if(analysis.type === 'rocket') { this.multiplier *= 2; ui.effectText('ROCKET'); }
        }

        // åˆ¤å®šèƒœè´Ÿ
        if(p.cards.length === 0) {
            this.state = 'OVER';
            ui.showToast(p.role === 'landlord' ? 'åœ°ä¸»èƒœåˆ©ï¼' : 'å†œæ°‘èƒœåˆ©ï¼');
            setTimeout(() => {
                document.getElementById('start-screen').style.display = 'flex';
                document.querySelector('.title-txt').innerText = "GAME OVER";
            }, 3000);
            return;
        }

        // è½®è½¬
        this.turn = (this.turn + 1) % 3;
        
        // å¦‚æœè¿ç»­ä¸¤äººä¸è¦ï¼Œæ¸…ç†æ¡Œé¢ï¼Œä¸‹å®¶éšæ„å‡º
        if(this.passCount >= 2) {
            this.lastPlay = null;
            this.passCount = 0;
            setTimeout(()=>ui.clearTable(), 500);
            ui.showToast(`æ²¡äººè¦ï¼ŒP${this.turn} éšæ„å‡º`);
        }

        this.loop();
    }
}

class UI {
    constructor() {
        this.zone = document.getElementById('controls');
    }

    // --- æŒ‰é’®æ¸²æŸ“ (å…³é”®ä¿®å¤) ---
    clearBtns() { this.zone.innerHTML = ''; }

    showBidBtns(currentMax) {
        this.clearBtns();
        [1,2,3].forEach(s => {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.innerText = `${s} åˆ†`;
            if(s <= currentMax) btn.disabled = true;
            else btn.onclick = () => { this.clearBtns(); game.handleBid(s); };
            this.zone.appendChild(btn);
        });
        const pass = document.createElement('button');
        pass.className = 'btn'; 
        pass.innerText = 'ä¸å«';
        pass.onclick = () => { this.clearBtns(); game.handleBid(0); };
        this.zone.appendChild(pass);
    }

    showSnatchBtns() {
        this.clearBtns();
        const b1 = document.createElement('button');
        b1.className = 'btn primary'; b1.innerText = 'æŠ¢åœ°ä¸» (x2)';
        b1.onclick = () => { this.clearBtns(); game.handleSnatch(true); };
        
        const b2 = document.createElement('button');
        b2.className = 'btn'; b2.innerText = 'ä¸æŠ¢';
        b2.onclick = () => { this.clearBtns(); game.handleSnatch(false); };
        
        this.zone.appendChild(b1); this.zone.appendChild(b2);
    }

    showPlayBtns(lastPlay) {
        this.clearBtns();
        
        // å‡ºç‰ŒæŒ‰é’®
        const playBtn = document.createElement('button');
        playBtn.className = 'btn primary'; 
        playBtn.innerText = 'å‡ºç‰Œ';
        playBtn.onclick = () => {
            // è·å–é€‰ä¸­çš„ç‰Œ
            const selected = game.players[0].cards.filter(c=>c.selected);
            if(!selected.length) { this.showToast('è¯·é€‰ç‰Œ'); return; }
            // è§„åˆ™æ ¡éªŒ
            if(!Rule.canBeat(lastPlay ? lastPlay.typeObj : null, selected)) {
                this.showToast('æ‰“ä¸è¿‡ / ç‰Œå‹ä¸å¯¹'); return;
            }
            this.clearBtns();
            game.handlePlay(selected);
        };
        this.zone.appendChild(playBtn);

        // ä¸å‡ºæŒ‰é’® (å¦‚æœæ˜¯é¦–å‡ºï¼Œä¸èƒ½ä¸å‡º)
        const passBtn = document.createElement('button');
        passBtn.className = 'btn'; 
        passBtn.innerText = 'ä¸è¦';
        if(!lastPlay || lastPlay.pid === 0) passBtn.disabled = true;
        else {
            passBtn.onclick = () => {
                this.clearBtns();
                game.handlePlay([]); // ç©ºæ•°ç»„=ä¸å‡º
            };
        }
        this.zone.appendChild(passBtn);
    }

    // --- åŸºç¡€æ¸²æŸ“ ---
    renderHand(cards) {
        const div = document.getElementById('my-hand');
        div.innerHTML = '';
        const w = 800;
        const total = cards.length;
        const step = Math.min(40, w / total); // åŠ¨æ€é—´è·
        const startLeft = (w - (total-1)*step - 90)/2;

        cards.forEach((c, i) => {
            const el = document.createElement('div');
            el.className = `card ${c.isRed?'suit-red':'suit-black'} ${c.selected?'selected':''}`;
            el.style.left = (startLeft + i*step) + 'px';
            el.innerHTML = `<div class="card-val">${c.label}</div><div class="card-suit">${c.val>15?'':c.suit}</div><div class="card-center">${c.val>15?'â˜…':c.suit}</div>`;
            el.onclick = () => {
                c.selected = !c.selected;
                this.renderHand(cards); // é‡ç»˜ç»´æŒçŠ¶æ€
            };
            div.appendChild(el);
        });
    }

    displayPlay(pid, cards) {
        const zone = document.getElementById(`play-${pid}`);
        zone.innerHTML = '';
        if(!cards.length) return; // ä¸å‡ºä¸æ˜¾ç¤ºç‰Œ

        cards.forEach((c, i) => {
            const el = document.createElement('div');
            el.className = `card ${c.isRed?'suit-red':'suit-black'}`;
            el.style.transform = 'scale(0.7)'; // æ¡Œé¢ç‰Œå°ä¸€ç‚¹
            el.style.position = 'relative';
            el.style.left = (i * -60) + 'px'; // å åœ¨ä¸€èµ·
            el.innerHTML = `<div class="card-val">${c.label}</div><div class="card-suit">${c.val>15?'':c.suit}</div>`;
            zone.appendChild(el);
        });
    }

    clearTable() {
        [0,1,2].forEach(i => document.getElementById(`play-${i}`).innerHTML = '');
    }

    revealHole() {
        const els = document.querySelectorAll('.hole-card');
        game.holeCards.forEach((c, i) => {
            els[i].classList.add('revealed');
            els[i].innerHTML = `<span style="color:${c.isRed?'red':'black'}">${c.label}</span>`;
        });
    }

    updateCounts() {
        document.getElementById('cnt-1').innerText = game.players[1].cards.length;
        document.getElementById('cnt-2').innerText = game.players[2].cards.length;
    }

    highlightAvatar(pid) {
        [0,1,2].forEach(i => {
            const av = document.getElementById(`av-${i}`);
            if(i === pid) av.classList.add('active');
            else av.classList.remove('active');
        });
    }

    bubble(pid, text) {
        const el = document.getElementById(`bubble-${pid}`);
        el.innerText = text;
        el.classList.add('show');
        setTimeout(() => el.classList.remove('show'), 1500);
    }

    updateRoles() {
        game.players.forEach(p => {
            const el = document.getElementById(`role-${p.id}`);
            el.innerText = p.role==='landlord' ? 'åœ°ä¸»' : 'å†œæ°‘';
            el.style.background = p.role==='landlord' ? 'var(--neon-gold)' : '#333';
            el.style.color = p.role==='landlord' ? 'black' : 'white';
        });
    }

    showToast(msg) {
        const d = document.createElement('div');
        d.style.cssText = "position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border:1px solid var(--neon-blue); border-radius:4px; z-index:2000; font-size:20px;";
        d.innerText = msg;
        document.body.appendChild(d);
        setTimeout(()=>d.remove(), 2000);
    }
    
    effectText(txt) {
        const d = document.createElement('div');
        d.className = 'fx-text';
        d.innerText = txt;
        d.style.left = '50%'; d.style.top = '40%';
        document.body.appendChild(d);
        setTimeout(()=>d.remove(), 1000);
    }

    updateInfo() {
        document.getElementById('state-display').innerText = game.state;
        document.getElementById('mul-display').innerText = "x" + game.multiplier;
    }
}

const ui = new UI();
const game = new Game();

</script>
</body>
</html>